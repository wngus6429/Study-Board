# 📱 실시간 채널 채팅 시스템 가이드

## 📋 목차

- [프로젝트 개요](#프로젝트-개요)
- [기술 스택](#기술-스택)
- [데이터베이스 설계](#데이터베이스-설계)
- [백엔드 구조](#백엔드-구조)
- [프론트엔드 구조](#프론트엔드-구조)
- [핵심 기능](#핵심-기능)
- [설치 및 실행](#설치-및-실행)
- [API 명세](#api-명세)
- [WebSocket 이벤트](#websocket-이벤트)
- [파일 구조](#파일-구조)
- [주요 특징](#주요-특징)
- [추후 개선 사항](#추후-개선-사항)

---

## 🎯 프로젝트 개요

Study-Board 애플리케이션에 실시간 채널 채팅 기능을 추가한 시스템입니다.
사용자들이 특정 채널에서 실시간으로 대화할 수 있으며, 메시지는 데이터베이스에 영구 저장됩니다.

### 주요 기능

- ✅ 실시간 채팅 (WebSocket 기반)
- ✅ 메시지 영구 저장 (MySQL)
- ✅ 사용자 인증 및 세션 관리
- ✅ 채널별 채팅방 분리
- ✅ 반응형 UI 디자인
- ✅ 연결 상태 표시
- ✅ 메시지 삭제 (본인 메시지만)
- ✅ 온라인 사용자 수 표시

---

## 🔧 기술 스택

### 백엔드

- **NestJS**: Node.js 프레임워크
- **Socket.io**: WebSocket 실시간 통신
- **TypeORM**: 데이터베이스 ORM
- **MySQL**: 관계형 데이터베이스
- **JWT**: 사용자 인증

### 프론트엔드

- **React**: 사용자 인터페이스
- **Next.js**: React 프레임워크
- **Material-UI**: UI 컴포넌트 라이브러리
- **Socket.io-client**: WebSocket 클라이언트
- **TypeScript**: 정적 타입 지원

---

## 🗃️ 데이터베이스 설계

### ChannelChatMessage 엔티티

```typescript
interface ChannelChatMessage {
  id: number; // 메시지 고유 ID
  message: string; // 메시지 내용 (최대 1000자)
  created_at: Date; // 생성 시간
  updated_at: Date; // 수정 시간

  // 관계
  channel: Channel; // 소속 채널
  user: User; // 작성자

  // 외래키
  channel_id: number;
  user_id: number;
}
```

### 인덱스 최적화

- `IDX_channel_created`: (channel_id, created_at) - 채널별 최신 메시지 조회 최적화

---

## 🏗️ 백엔드 구조

### 📁 디렉토리 구조

```
src/channel-chat/
├── channel-chat.module.ts      # 모듈 정의
├── channel-chat.service.ts     # 비즈니스 로직
├── channel-chat.controller.ts  # REST API 컨트롤러
└── channel-chat.gateway.ts     # WebSocket 게이트웨이
```

### 핵심 서비스 (ChannelChatService)

```typescript
class ChannelChatService {
  // 채팅 메시지 조회 (페이지네이션)
  getChannelChatMessages(channelId, page, limit);

  // 메시지 전송
  sendChannelChatMessage(channelId, userId, message);

  // 메시지 삭제 (본인만)
  deleteChannelChatMessage(messageId, userId);

  // 채널 입장/퇴장
  joinChannelChat(channelId, userId);
  leaveChannelChat(channelId, userId);
}
```

### WebSocket 게이트웨이 이벤트

- `join_channel`: 채널 입장
- `leave_channel`: 채널 퇴장
- `send_message`: 메시지 전송
- `typing`: 입력 중 상태

---

## 🖥️ 프론트엔드 구조

### 핵심 컴포넌트

```typescript
// 채팅 상태 관리
const [showChat, setShowChat] = useState(false);
const [chatMessages, setChatMessages] = useState<ChannelChatMessage[]>([]);
const [newMessage, setNewMessage] = useState("");
const [onlineCount, setOnlineCount] = useState(0);
```

### WebSocket 클래스 (utils/websocket.ts)

```typescript
class ChannelChatWebSocket {
  connect(channelId, user); // 채널 연결
  disconnect(); // 연결 해제
  sendMessage(message); // 메시지 전송
  onMessage(callback); // 메시지 수신 콜백
  onStatusChange(callback); // 상태 변경 콜백
}
```

### UI 토글 시스템

- 일반 모드: 게시글/댓글 표시
- 채팅 모드: 실시간 채팅 인터페이스
- Material-UI Drawer 방식에서 전체 화면 방식으로 변경

---

## ⚡ 핵심 기능

### 1. 실시간 메시징

- WebSocket을 통한 즉시 메시지 전달
- 채널별 독립적인 채팅방
- 자동 재연결 기능 (최대 5회)

### 2. 메시지 관리

- 메시지 영구 저장 (MySQL)
- 페이지네이션 지원 (기본 50개씩)
- 본인 메시지 삭제 가능
- 1000자 제한

### 3. 사용자 관리

- JWT 토큰 기반 인증
- 닉네임 표시
- 온라인 사용자 수 실시간 표시
- 세션 관리

### 4. UI/UX

- 반응형 디자인
- Material-UI 컴포넌트 사용
- 연결 상태 인디케이터
- 스크롤 자동 조정

---

## 🚀 설치 및 실행

### 백엔드 설정

```bash
cd back
npm install @nestjs/websockets@^10.0.0 @nestjs/platform-socket.io@^10.0.0 socket.io@^4.7.0 --legacy-peer-deps
npm run start:dev
```

### 프론트엔드 설정

```bash
cd front
npm install socket.io-client
npm run dev
```

### 환경 변수 설정

```env
# front/.env.local
NEXT_PUBLIC_WEBSOCKET_URL=http://localhost:3001
```

---

## 📡 API 명세

### REST API 엔드포인트

#### 메시지 조회

```
GET /channel-chat/:channelId/messages?page=1&limit=50
```

#### 메시지 전송

```
POST /channel-chat/:channelId/messages
Body: { message: string }
```

#### 메시지 삭제

```
DELETE /channel-chat/messages/:messageId
```

#### 채널 입장

```
POST /channel-chat/:channelId/join
```

#### 채널 퇴장

```
POST /channel-chat/:channelId/leave
```

### 응답 형식

```typescript
interface ChannelChatResponse {
  success: boolean;
  data: ChannelChatMessage[];
  pagination?: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}
```

---

## 🔌 WebSocket 이벤트

### 클라이언트 → 서버

| 이벤트명        | 데이터                    | 설명        |
| --------------- | ------------------------- | ----------- |
| `join_channel`  | `{ channelId, user }`     | 채널 입장   |
| `leave_channel` | `{ channelId }`           | 채널 퇴장   |
| `send_message`  | `{ channelId, message }`  | 메시지 전송 |
| `typing`        | `{ channelId, isTyping }` | 입력 상태   |

### 서버 → 클라이언트

| 이벤트명      | 데이터                  | 설명        |
| ------------- | ----------------------- | ----------- |
| `new_message` | `ChannelChatMessage`    | 새 메시지   |
| `user_joined` | `{ user, onlineCount }` | 사용자 입장 |
| `user_left`   | `{ user, onlineCount }` | 사용자 퇴장 |
| `user_typing` | `{ user, isTyping }`    | 입력 상태   |
| `error`       | `{ message }`           | 오류 발생   |

---

## 📂 파일 구조

```
Study-Board/
├── back/
│   ├── src/
│   │   ├── entities/
│   │   │   ├── ChannelChatMessage.entity.ts
│   │   │   ├── Channels.entity.ts (수정)
│   │   │   └── user.entity.ts (수정)
│   │   ├── channel-chat/
│   │   │   ├── channel-chat.module.ts
│   │   │   ├── channel-chat.service.ts
│   │   │   ├── channel-chat.controller.ts
│   │   │   └── channel-chat.gateway.ts
│   │   └── app.module.ts (수정)
│   └── package.json (의존성 추가)
└── front/
    ├── src/
    │   ├── app/
    │   │   ├── (noLogin)/channels/[slug]/page.tsx (수정)
    │   │   └── api/channelChatApi.ts
    │   └── utils/
    │       └── websocket.ts
    └── package.json (의존성 추가)
```

---

## ✨ 주요 특징

### 1. 확장성

- 모듈화된 구조로 쉬운 기능 추가
- TypeORM으로 데이터베이스 관리 용이
- RESTful API와 WebSocket 이중 지원

### 2. 안정성

- 자동 재연결 기능
- 에러 핸들링 및 로깅
- 백업 API 호출 (WebSocket 실패 시)

### 3. 성능

- 데이터베이스 인덱스 최적화
- 페이지네이션으로 메모리 효율성
- Socket.io 룸을 통한 효율적인 메시지 브로드캐스팅

### 4. 보안

- JWT 토큰 인증
- 본인 메시지만 삭제 가능
- SQL 인젝션 방지 (TypeORM)

---

## 🔮 추후 개선 사항

### 단기 개선

- [ ] 메시지 편집 기능
- [ ] 이미지/파일 전송
- [ ] 이모지 반응
- [ ] 멘션 기능 (@사용자명)

### 중기 개선

- [ ] 메시지 검색 기능
- [ ] 채팅 테마 커스터마이징
- [ ] 알림 설정
- [ ] 모바일 앱 푸시 알림

### 장기 개선

- [ ] 음성/영상 통화
- [ ] 화면 공유
- [ ] 봇 연동 (ChatGPT 등)
- [ ] 메시지 암호화

---

## 🆘 문제 해결

### 자주 발생하는 문제

1. **WebSocket 연결 실패**

   - CORS 설정 확인
   - 포트 충돌 확인 (3001)
   - 환경 변수 설정 확인

2. **메시지가 안 보임**

   - 인증 토큰 확인
   - 네트워크 연결 상태 확인
   - 브라우저 콘솔 에러 확인

3. **데이터베이스 오류**
   - MySQL 연결 설정 확인
   - 테이블 마이그레이션 실행
   - 외래키 제약 조건 확인

---

## 📞 문의 및 지원

개발 과정에서 생긴 파일들:

- `back/src/channel-chat/` - 백엔드 채팅 모듈
- `front/src/app/api/channelChatApi.ts` - API 클라이언트
- `front/src/app/utils/websocket.ts` - WebSocket 클라이언트

이 문서는 실시간 채널 채팅 시스템의 전체적인 구조와 사용법을 담고 있습니다.
추가 질문이나 기능 개선이 필요하면 언제든 말씀해 주세요! 🚀
